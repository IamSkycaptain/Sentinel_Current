clear
ocn_list = ['s1a-iw-ocn-vv-20180105t112300-20180105t112332-020019-0221A7-001.nc';
    's1a-iw-ocn-vv-20180117t112300-20180117t112332-020194-02273A-001.nc';
    's1a-iw-ocn-vv-20180129t112259-20180129t112332-020369-022CC6-001.nc';
    's1a-iw-ocn-vv-20180210t112259-20180210t112332-020544-023262-001.nc';
    's1a-iw-ocn-vv-20180222t112259-20180222t112331-020719-0237F6-001.nc';
    's1a-iw-ocn-vv-20180306t112259-20180306t112331-020894-023D7D-001.nc';
    's1a-iw-ocn-vv-20180318t112259-20180318t112331-021069-024305-001.nc';
    's1a-iw-ocn-vv-20180330t112259-20180330t112332-021244-024897-001.nc';
    's1a-iw-ocn-vv-20180411t112300-20180411t112332-021419-024E0D-001.nc';
    's1a-iw-ocn-vv-20180423t112300-20180423t112333-021594-025380-001.nc';
    's1a-iw-ocn-vv-20180505t112301-20180505t112333-021769-025908-001.nc';
    's1a-iw-ocn-vv-20180517t112301-20180517t112334-021944-025E96-001.nc';
    's1a-iw-ocn-vv-20180529t112302-20180529t112334-022119-026436-001.nc';
    's1a-iw-ocn-vv-20180610t112303-20180610t112335-022294-0269AD-001.nc';
    's1a-iw-ocn-vv-20180622t112304-20180622t112336-022469-026EF6-001.nc';
    's1a-iw-ocn-vv-20180704t112304-20180704t112336-022644-02740E-001.nc';
    's1a-iw-ocn-vv-20180716t112305-20180716t112337-022819-027957-001.nc';
    's1a-iw-ocn-vv-20180728t112306-20180728t112338-022994-027EDF-001.nc';
    's1a-iw-ocn-vv-20180809t112306-20180809t112339-023169-02845B-001.nc';
    's1a-iw-ocn-vv-20180821t112307-20180821t112339-023344-028A02-001.nc';
    's1a-iw-ocn-vv-20180902t112308-20180902t112340-023519-028F91-001.nc';
    's1a-iw-ocn-vv-20180914t112308-20180914t112341-023694-02952E-001.nc';
    's1a-iw-ocn-vv-20180926t112308-20180926t112341-023869-029ADC-001.nc';
    's1a-iw-ocn-vv-20181008t112309-20181008t112341-024044-02A09D-001.nc';
    's1a-iw-ocn-vv-20181020t112309-20181020t112341-024219-02A64E-001.nc';
    's1a-iw-ocn-vv-20181101t112309-20181101t112341-024394-02AC05-001.nc';
    's1a-iw-ocn-vv-20181113t112308-20181113t112341-024569-02B26B-001.nc';
    's1a-iw-ocn-vv-20181125t112308-20181125t112341-024744-02B8DC-001.nc';
    's1a-iw-ocn-vv-20181207t112308-20181207t112340-024919-02BEB6-001.nc';
    's1a-iw-ocn-vv-20181219t112307-20181219t112340-025094-02C50F-001.nc';
    's1a-iw-ocn-vv-20181231t112307-20181231t112339-025269-02CB62-001.nc';
    's1a-iw-ocn-vv-20190112t112306-20190112t112339-025444-02D1AB-001.nc';
    's1a-iw-ocn-vv-20190124t112306-20190124t112339-025619-02D80E-001.nc';
    's1a-iw-ocn-vv-20190205t112305-20190205t112338-025794-02DE64-001.nc';
    's1a-iw-ocn-vv-20190217t112305-20190217t112338-025969-02E499-001.nc';
    's1a-iw-ocn-vv-20190301t112305-20190301t112338-026144-02EADE-001.nc';
    's1a-iw-ocn-vv-20190313t112305-20190313t112338-026319-02F13C-001.nc';
    's1a-iw-ocn-vv-20190325t112306-20190325t112338-026494-02F7B1-001.nc';
    's1a-iw-ocn-vv-20190406t112306-20190406t112338-026669-02FE28-001.nc';
    's1a-iw-ocn-vv-20190430t112307-20190430t112339-027019-030ADC-001.nc';
    's1a-iw-ocn-vv-20190524t112308-20190524t112340-027369-031646-001.nc';
    's1a-iw-ocn-vv-20190629t112310-20190629t112342-027894-032632-001.nc';
    's1a-iw-ocn-vv-20190816t112313-20190816t112346-028594-033BF9-001.nc';
    's1a-iw-ocn-vv-20190828t112314-20190828t112346-028769-034219-001.nc';
    's1a-iw-ocn-vv-20191015t112315-20191015t112347-029469-035A3C-001.nc';
    's1a-iw-ocn-vv-20191027t112315-20191027t112347-029644-03603D-001.nc';
    's1a-iw-ocn-vv-20191108t112315-20191108t112348-029819-036672-001.nc';
    's1a-iw-ocn-vv-20191120t112315-20191120t112347-029994-036C80-001.nc';
    's1a-iw-ocn-vv-20191202t112314-20191202t112347-030169-03728F-001.nc';
    's1a-iw-ocn-vv-20191214t112314-20191214t112346-030344-03789A-001.nc';
    's1a-iw-ocn-vv-20191226t112313-20191226t112346-030519-037EA2-001.nc';
    's1a-iw-ocn-vv-20200107t112313-20200107t112345-030694-0384B0-001.nc';
    's1a-iw-ocn-vv-20200119t112312-20200119t112345-030869-038AD7-001.nc';
    's1a-iw-ocn-vv-20200131t112312-20200131t112345-031044-0390F2-001.nc';
    's1a-iw-ocn-vv-20200212t112312-20200212t112344-031219-03970B-001.nc';
    's1a-iw-ocn-vv-20200224t112312-20200224t112344-031394-039D11-001.nc';
    's1a-iw-ocn-vv-20200307t112312-20200307t112344-031569-03A31D-001.nc';
    's1a-iw-ocn-vv-20200319t112312-20200319t112344-031744-03A939-001.nc';
    's1a-iw-ocn-vv-20200331t112312-20200331t112345-031919-03AF62-001.nc';
    's1a-iw-ocn-vv-20200412t112312-20200412t112345-032094-03B58F-001.nc';
    's1a-iw-ocn-vv-20200424t112313-20200424t112345-032269-03BBB1-001.nc';
    's1a-iw-ocn-vv-20200506t112313-20200506t112346-032444-03C1D4-001.nc';
    's1a-iw-ocn-vv-20200518t112314-20200518t112347-032619-03C729-001.nc';
    's1a-iw-ocn-vv-20200530t112315-20200530t112347-032794-03CC71-001.nc';
    's1a-iw-ocn-vv-20200611t112316-20200611t112348-032969-03D19F-001.nc';
    's1a-iw-ocn-vv-20200623t112844-20200623t112909-033144-03D6F1-001.nc';
    's1a-iw-ocn-vv-20200705t112845-20200705t112910-033319-03DC3C-001.nc';
    's1a-iw-ocn-vv-20200717t112846-20200717t112911-033494-03E197-001.nc';
    's1a-iw-ocn-vv-20200729t112846-20200729t112911-033669-03E6F6-001.nc';
    's1a-iw-ocn-vv-20200810t112847-20200810t112912-033844-03EC9F-001.nc';
    's1a-iw-ocn-vv-20200822t112848-20200822t112913-034019-03F2C9-001.nc';
    's1a-iw-ocn-vv-20200903t112848-20200903t112913-034194-03F8ED-001.nc';
    's1a-iw-ocn-vv-20200915t112849-20200915t112914-034369-03FF1C-001.nc';
    's1a-iw-ocn-vv-20200927t112849-20200927t112914-034544-040549-001.nc';
    's1a-iw-ocn-vv-20201009t112849-20201009t112914-034719-040B66-001.nc';
    's1a-iw-ocn-vv-20201021t112849-20201021t112914-034894-041182-001.nc';
    's1a-iw-ocn-vv-20201102t112849-20201102t112914-035069-04177D-001.nc';
    's1a-iw-ocn-vv-20201114t112849-20201114t112914-035244-041DA0-001.nc';
    's1a-iw-ocn-vv-20201208t112848-20201208t112913-035594-0429B5-001.nc';
    's1a-iw-ocn-vv-20201220t112848-20201220t112913-035769-042FB5-001.nc'];

ocn_list = ocn_list([32:65],:);
for p = 1:size(ocn_list,1)
    clear lon_sw lat_sw v_sw h_sw inc_sw land_sw
    ncfile = ocn_list(p,:);
    lon = ncread(ncfile,'rvlLon');
    lat = ncread(ncfile,'rvlLat');
    v = ncread(ncfile,'rvlRadVel');
    h = ncread(ncfile,'rvlHeading');
    inc = ncread(ncfile,'rvlIncidenceAngle');
    land = ncread(ncfile,'rvlLandFlag');
    [swath,row,col] = size(v);
    for sw = 1:3
        for r = 1:row
            for c = 1:col
                lat_sw{sw}(r,c) = lat(sw,r,c);
                lon_sw{sw}(r,c) = lon(sw,r,c);
                v_sw{sw}(r,c) = v(sw,r,c);
                h_sw{sw}(r,c) = h(sw,r,c);
                inc_sw{sw}(r,c) = inc(sw,r,c);
                land_sw{sw}(r,c) = land(sw,r,c);
            end
        end
    end
    clear lon lat v h r c row col inc land
    lon = [lon_sw{1}(:);lon_sw{2}(:);lon_sw{3}(:)];
    lat = [lat_sw{1}(:);lat_sw{2}(:);lat_sw{3}(:)];
    v = [v_sw{1}(:);v_sw{2}(:);v_sw{3}(:)];
    t = [lon,lat,v];
    
    land_flag = 0;
    if land_flag==1
        v_sw{1}(land_sw{1}==1) = nan;
        v_sw{2}(land_sw{2}==1) = nan;
        v_sw{3}(land_sw{3}==1) = nan;
    end
    
    %----- Swap dimension to make it coincide with the geography
    for sw = 1:3
        lon_sw{sw} = flipud(lon_sw{sw}');
        lat_sw{sw} = flipud(lat_sw{sw}');
        v_sw{sw} = flipud(v_sw{sw}');
        h_sw{sw} = flipud(h_sw{sw}');
        inc_sw{sw} = flipud(inc_sw{sw}');
        land_sw{sw} = flipud(land_sw{sw}');
    end
    v_sw{1}(:,[108,109]) = nan; %-------------------------- Check that the problem occur in every acquisition or not.
    v_sw{2}(:,[129,130]) = nan;
    v_sw{3}(:,125) = nan;
    
    %----- 1. Detect outliers
    for sw = 1:3
        [row, column] = size(v_sw{sw});
        clear v_ix_nan_row v_ix_nan_column
        for r = 1:row
            v_loop = v_sw{sw}(r,:);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_row(r,:) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        for c = 1:column
            v_loop = v_sw{sw}(:,c);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_column(:,c) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        v_ix_nan = v_ix_nan_row+v_ix_nan_column;
        v_sw{sw}(v_ix_nan>0) = nan;
        range_average{p,sw} = nanmean(v_sw{sw},2)'; %--------------- Collect range average of every image for the second correction
    end
end

figure
grid
hold on
for p = 1:size(range_average,1)
    plot([1:size(range_average{p,3},2)],range_average{p,3},'o-')
    pause
end

clear range_average_sw1 range_average_sw2 range_average_sw3
for p = 1:size(range_average,1)
    if size(range_average{p,1},2)<234
        range_average_sw1(p,:) = [range_average{p,1} nan];
        range_average_sw2(p,:) = [range_average{p,2} nan];
        range_average_sw3(p,:) = [range_average{p,3} nan];
    else
        range_average_sw1(p,:) = range_average{p,1};
        range_average_sw2(p,:) = range_average{p,2};
        range_average_sw3(p,:) = range_average{p,3};
    end
end
figure
plot([1:234],mean(range_average_sw1),'ro-')
grid
figure
plot([1:234],mean(range_average_sw2),'ro-')
grid
figure
plot([1:234],mean(range_average_sw3),'ro-')
grid


%% Generating Interpolation part
load('corr_amp_sw1.mat')
x = [1:234];
scal_sw1 = interp1(corr_amp(:,1),corr_amp(:,2),x)
figure
hold on
grid
plot(x,scal_sw1,'gx-')
plot([1:234],mean(range_average_sw1),'ro-')
plot([1:234],mean(range_average_sw1)-scal_sw1,'ko-')

clear corr_amp
load('corr_amp_sw2.mat')
x = [1:234];
scal_sw2 = interp1(corr_amp(:,1),corr_amp(:,2),x);
figure
hold on
grid
plot([1:234],mean(range_average_sw1),'ro-')
plot(x,scal_sw2,'gx-')
plot([1:234],mean(range_average_sw2)-scal_sw2,'ko-')

clear corr_amp
load('corr_amp_sw3.mat')
x = [1:234];
scal_sw3 = interp1(corr_amp(:,1),corr_amp(:,2),x);
figure
hold on
grid
plot([1:234],mean(range_average_sw1),'ro-')
plot(x,scal_sw3,'gx-')
plot([1:234],mean(range_average_sw3)-scal_sw3,'ko-')

scal_corr_sw1 = repmat(scal_sw1',1,130);
scal_corr_sw2 = repmat(scal_sw2',1,130);
scal_corr_sw3 = repmat(scal_sw3',1,130);

save('scal_corr_sw1.mat','scal_corr_sw1') %----- They have 234 pixels long in azimuth direction need to check before applying
save('scal_corr_sw2.mat','scal_corr_sw2')
save('scal_corr_sw3.mat','scal_corr_sw3')

%% Estimating Range variation part/Uncorrected antenna electronic mispointing
load('scal_corr_sw1.mat')
load('scal_corr_sw2.mat')
load('scal_corr_sw3.mat')
scal_corr_sw{1} = scal_corr_sw1;
scal_corr_sw{2} = scal_corr_sw2;
scal_corr_sw{3} = scal_corr_sw3;
azimuth_median = {};
for p = 1:size(ocn_list,1)
    clear lon_sw lat_sw v_sw h_sw inc_sw land_sw
    ncfile = ocn_list(p,:);
    lon = ncread(ncfile,'rvlLon');
    lat = ncread(ncfile,'rvlLat');
    v = ncread(ncfile,'rvlRadVel');
    h = ncread(ncfile,'rvlHeading');
    inc = ncread(ncfile,'rvlIncidenceAngle');
    land = ncread(ncfile,'rvlLandFlag');
    [swath,row,col] = size(v);
    for sw = 1:3
        for r = 1:row
            for c = 1:col
                lat_sw{sw}(r,c) = lat(sw,r,c);
                lon_sw{sw}(r,c) = lon(sw,r,c);
                v_sw{sw}(r,c) = v(sw,r,c);
                h_sw{sw}(r,c) = h(sw,r,c);
                inc_sw{sw}(r,c) = inc(sw,r,c);
                land_sw{sw}(r,c) = land(sw,r,c);
            end
        end
    end
    clear lon lat v h r c row col inc land
    lon = [lon_sw{1}(:);lon_sw{2}(:);lon_sw{3}(:)];
    lat = [lat_sw{1}(:);lat_sw{2}(:);lat_sw{3}(:)];
    v = [v_sw{1}(:);v_sw{2}(:);v_sw{3}(:)];
    t = [lon,lat,v];
    
    land_flag = 1; %-------- Use only Land pixel
    if land_flag==1
        v_sw{1}(land_sw{1}==0) = nan;
        v_sw{2}(land_sw{2}==0) = nan;
        v_sw{3}(land_sw{3}==0) = nan;
    end
    
    %----- Swap dimension to make it coincide with the geography
    for sw = 1:3
        lon_sw{sw} = flipud(lon_sw{sw}');
        lat_sw{sw} = flipud(lat_sw{sw}');
        v_sw{sw} = flipud(v_sw{sw}');
        h_sw{sw} = flipud(h_sw{sw}');
        inc_sw{sw} = flipud(inc_sw{sw}');
        land_sw{sw} = flipud(land_sw{sw}');
    end
    v_sw{1}(:,[108,109]) = nan; %-------------------------- Check that the problem occur in every acquisition or not.
    v_sw{2}(:,[129,130]) = nan;
    v_sw{3}(:,125) = nan;
    
    %----- 1. Detect outliers
    for sw = 1:3
        [row, column] = size(v_sw{sw});
        clear v_ix_nan_row v_ix_nan_column
        for r = 1:row
            v_loop = v_sw{sw}(r,:);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_row(r,:) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        for c = 1:column
            v_loop = v_sw{sw}(:,c);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_column(:,c) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        v_ix_nan = v_ix_nan_row+v_ix_nan_column;
        v_sw{sw}(v_ix_nan>0) = nan;
        
        if column<130
            v_sw{sw} = [v_sw{sw} nan(row,130-column)];  %--------------- Try to make it possible to be averaged. They will be averaged many times so I think it's still OK.
        end
        
        if row == 233
            corr_v_sw = v_sw{sw}-scal_corr_sw{sw}([1:end-1],:);
            if p == 1
                azimuth_median{1,sw} = nanmean(corr_v_sw);
            else
                azimuth_median{1,sw} = [azimuth_median{1,sw};nanmean(corr_v_sw)]; %--------------- Collect azimuth average of every image for the third correction (Antenna electronic mispointing correction)
            end
        else
            corr_v_sw = v_sw{sw}-scal_corr_sw{sw};
            if p == 1
                azimuth_median{1,sw} = nanmean(corr_v_sw);
            else
                azimuth_median{1,sw} = [azimuth_median{1,sw};nanmean(corr_v_sw)];
            end
            
        end
    end
end


%-------------- Calculate median values 
for sw = 1:3
    figure
    hold on
    grid
    plot([1:size(azimuth_median{sw},2)],azimuth_median{sw},'-')
    azi_median_med{sw} = nanmedian(azimuth_median{sw});
    plot([1:size(azi_median_med{sw},2)],azi_median_med{sw},'ro')
end


%--------------- Estimate linear model ------------------------------------
for sw = 1:3
    x = [1:size(azi_median_med{sw},2)]';
    y = azi_median_med{sw}';
    ix_nan = find(isnan(y));
    x(ix_nan) = [];
    y(ix_nan) = [];
    A = [x ones(size(x,1),1)];
    m(:,sw) = lscov(A,y);
    
    figure
    plot(x,y,'bx')
    hold on 
    grid
    plot(x,A*m(:,sw),'ro-')
    pause
    close all
end


%--------------- Generating correction for convenient ----------------------
x = [1:130]';
A = [x ones(size(x,1),1)];
range_corr_sw1= A*m(:,1);
range_corr_sw2= A*m(:,2);
range_corr_sw3= A*m(:,3);
save('range_corr_sw1.mat','range_corr_sw1')
save('range_corr_sw2.mat','range_corr_sw2')
save('range_corr_sw3.mat','range_corr_sw3')



%% Estimating along-track variation
% repmat for a swath / cut column first / then repmat follow the number of rows
clear
load('scal_corr_sw1.mat')
load('scal_corr_sw2.mat')
load('scal_corr_sw3.mat')
scal_corr_sw{1} = scal_corr_sw1;
scal_corr_sw{2} = scal_corr_sw2;
scal_corr_sw{3} = scal_corr_sw3;
load('range_corr_sw1.mat')
load('range_corr_sw2.mat')
load('range_corr_sw3.mat')
range_corr_sw{1} = range_corr_sw1;
range_corr_sw{2} = range_corr_sw2;
range_corr_sw{3} = range_corr_sw3;
v_sw_stack = {};
load ocn_list

for p = 1:size(ocn_list,1)
    clear lon_sw lat_sw v_sw h_sw inc_sw land_sw
    ncfile = ocn_list(p,:);
    lon = ncread(ncfile,'rvlLon');
    lat = ncread(ncfile,'rvlLat');
    v = ncread(ncfile,'rvlRadVel');
    h = ncread(ncfile,'rvlHeading');
    inc = ncread(ncfile,'rvlIncidenceAngle');
    land = ncread(ncfile,'rvlLandFlag');
    [swath,row,col] = size(v);
    for sw = 1:3
        for r = 1:row
            for c = 1:col
                lat_sw{sw}(r,c) = lat(sw,r,c);
                lon_sw{sw}(r,c) = lon(sw,r,c);
                v_sw{sw}(r,c) = v(sw,r,c);
                h_sw{sw}(r,c) = h(sw,r,c);
                inc_sw{sw}(r,c) = inc(sw,r,c);
                land_sw{sw}(r,c) = land(sw,r,c);
            end
        end
    end
    clear lon lat v h r c row col inc land
    lon = [lon_sw{1}(:);lon_sw{2}(:);lon_sw{3}(:)];
    lat = [lat_sw{1}(:);lat_sw{2}(:);lat_sw{3}(:)];
    v = [v_sw{1}(:);v_sw{2}(:);v_sw{3}(:)];
    t = [lon,lat,v];
    
    land_flag = 1; %-------- Use only Land pixel
    if land_flag==1
        v_sw{1}(land_sw{1}==0) = nan;
        v_sw{2}(land_sw{2}==0) = nan;
        v_sw{3}(land_sw{3}==0) = nan;
    end
    
    %----- Swap dimension to make it coincide with the geography
    for sw = 1:3
        lon_sw{sw} = flipud(lon_sw{sw}');
        lat_sw{sw} = flipud(lat_sw{sw}');
        v_sw{sw} = flipud(v_sw{sw}');
        h_sw{sw} = flipud(h_sw{sw}');
        inc_sw{sw} = flipud(inc_sw{sw}');
        land_sw{sw} = flipud(land_sw{sw}');
    end
    v_sw{1}(:,[108,109]) = nan; %-------------------------- Check that the problem occur in every acquisition or not.
    v_sw{2}(:,[129,130]) = nan;
    v_sw{3}(:,125) = nan;
    
    %----- 1. Detect outliers
    for sw = 1:3
        [row, column] = size(v_sw{sw});
        clear v_ix_nan_row v_ix_nan_column
        for r = 1:row
            v_loop = v_sw{sw}(r,:);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_row(r,:) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        for c = 1:column
            v_loop = v_sw{sw}(:,c);
            MAD = nanmedian(abs(v_loop-nanmedian(v_loop)));
            v_thres = MAD*1.48*3;
            v_ix_nan_column(:,c) = abs(v_loop-nanmedian(v_loop))>v_thres;
        end
        v_ix_nan = v_ix_nan_row+v_ix_nan_column;
        v_sw{sw}(v_ix_nan>0) = nan;
        
        if column<130
            v_sw{sw} = [v_sw{sw} nan(row,130-column)];  %--------------- Try to make it possible to be averaged. They will be averaged many times so I think it's still OK.
        end
        
        %----- Correct Scallopping
        if row == 233
            corr_scal_v_sw = v_sw{sw}-scal_corr_sw{sw}([1:end-1],:);
        else
            corr_scal_v_sw = v_sw{sw}-scal_corr_sw{sw};
        end
        %----- Correct Antenna Electronic Mispointing (Range Variation)
        corr_temp = range_corr_sw{sw};
        corr_temp = corr_temp';
        corr_temp = repmat(corr_temp,row,1);
        
        corr_range_v_sw = corr_scal_v_sw-corr_temp;
        v_sw_stack{p,sw} = corr_range_v_sw;
    end
end

%---- Arrange 3 sub-swath results in one framework
%---- They are mismatch about 8 lines. SW2 starts at line 8 and SW3 starts
%---- at line 15. Our v_sw_stack have already been flipped upside down.
corr_azi = {};
corr_azi_sw = {};
off_land_median = [];
off_land_median_sw = [];
for p = 1:size(ocn_list,1)
    v_sw1 = [nan(14,size(v_sw_stack{p,1},2));v_sw_stack{p,1}];
    v_sw2 = [nan(7,size(v_sw_stack{p,1},2));v_sw_stack{p,2};nan(7,size(v_sw_stack{p,1},2))];
    v_sw3 = [v_sw_stack{p,3};nan(14,size(v_sw_stack{p,1},2))];
    v_sw = [v_sw1 v_sw2 v_sw3];
    
    off_land_median(p,:) = [nanmedian(v_sw(:)) nanstd(v_sw(:))];
    v_sw = v_sw-nanmedian(v_sw(:));
    
    corr_azi_v = nanmedian(v_sw,2);
    corr_azi_filt_v = medfilt1(corr_azi_v,19);
    corr_azi{p,1} = corr_azi_filt_v;
   
    %corr_v_sw = v_sw-repmat(corr_azi_filt_v,1,size(v_sw,2));
    %off_land_median(p,:) = [nanmedian(corr_v_sw(:)) nanstd(corr_v_sw(:))];
    
    off_land_median_sw(p,:) = [nanmedian(v_sw1(:)) nanmedian(v_sw2(:)) nanmedian(v_sw3(:))];
    v_sw1 = v_sw1-nanmedian(v_sw1(:));
    v_sw2 = v_sw2-nanmedian(v_sw2(:));
    v_sw3 = v_sw3-nanmedian(v_sw3(:));
    
    clear corr_azi_v_sw corr_azi_filt_v_sw
    corr_azi_v_sw(:,1) = nanmedian(v_sw1,2);
    corr_azi_v_sw(:,2) = nanmedian(v_sw2,2);
    corr_azi_v_sw(:,3) = nanmedian(v_sw3,2);
    corr_azi_filt_v_sw(:,1) = medfilt1(corr_azi_v_sw(:,1),19);
    corr_azi_filt_v_sw(:,2) = medfilt1(corr_azi_v_sw(:,2),19);
    corr_azi_filt_v_sw(:,3) = medfilt1(corr_azi_v_sw(:,3),19);
    corr_azi_sw{p,1} = corr_azi_filt_v_sw;
end

%----- Do the Correction by the order the paper explain ------------------
%save('corr_azi.mat','corr_azi')
%save('off_land_median.mat','off_land_median')
%----- By the order that I think it actually is ------------------
save('corr_azi2.mat','corr_azi')
save('off_land_median2.mat','off_land_median')
%----- Try to resolve them by sub-swath --------------------------
save('corr_azi_sw.mat','corr_azi_sw')
save('off_land_median_sw.mat','off_land_median_sw')

load ocn_list
figure
hold on
for p = 1:size(ocn_list,1)
    plot([1:size(corr_azi{p},1)],corr_azi{p},'o-')
end
grid






























